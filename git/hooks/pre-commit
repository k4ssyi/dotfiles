#!/usr/bin/env bash

# Pre-commit フック
# 静的解析（shellcheck）とシークレット検出を実行する
# common.sh は source しない（.git/hooks/ コンテキストでは ensure_dotfiles_root が失敗するため）

set -euo pipefail

# カラー定義
readonly RED='\033[31m'
readonly GREEN='\033[32m'
readonly YELLOW='\033[33m'
readonly CYAN='\033[36m'
readonly NC='\033[0m'

# 終了コード（両チェックを実行後にまとめて判定）
exit_code=0

print_header() {
    echo -e "${CYAN}── $1 ──${NC}"
}

print_pass() {
    echo -e "${GREEN}PASS${NC}: $1"
}

print_fail() {
    echo -e "${RED}FAIL${NC}: $1"
}

print_warn() {
    echo -e "${YELLOW}WARN${NC}: $1"
}

# --------------------------------------------------------------------------
# チェック1: shellcheck
# --------------------------------------------------------------------------
run_shellcheck() {
    print_header "shellcheck"

    # ステージ済み .sh ファイルを取得（追加・コピー・変更のみ）
    local staged_files
    staged_files=$(git diff --cached --name-only --diff-filter=ACM -- '*.sh')

    if [[ -z "$staged_files" ]]; then
        print_pass "対象の .sh ファイルなし"
        return
    fi

    if ! command -v shellcheck &>/dev/null; then
        print_warn "shellcheck が未インストールです（スキップ）"
        print_warn "  brew install shellcheck で導入できます"
        return
    fi

    # 一時ディレクトリを作成し、関数終了時にまとめて削除（シグナル受信時の漏れ防止）
    local tmp_dir
    tmp_dir=$(mktemp -d "${TMPDIR:-/tmp}/pre-commit-XXXXXX")
    trap 'rm -rf "$tmp_dir"' RETURN

    local failed=0
    while IFS= read -r file; do
        # ステージ済みの内容を一時ファイルに書き出して検査（TOCTOU対策）
        local tmp rel_dir
        rel_dir=$(dirname "$file")
        mkdir -p "${tmp_dir}/${rel_dir}"
        tmp="${tmp_dir}/${file}"
        if ! git show ":$file" > "$tmp" 2>/dev/null; then
            continue
        fi
        # SC1091: source先が一時ディレクトリで解決不可  SC2088: チルダ展開注意（dotfilesでは頻出）
        if ! shellcheck -x --exclude=SC1091,SC2088 "$tmp"; then
            echo "  -> $file"
            failed=1
        fi
    done <<< "$staged_files"

    if [[ "$failed" -eq 1 ]]; then
        print_fail "shellcheck でエラーが検出されました"
        exit_code=1
    else
        print_pass "shellcheck"
    fi
}

# --------------------------------------------------------------------------
# チェック2: シークレット検出
# --------------------------------------------------------------------------
run_secrets_check() {
    print_header "secrets"

    # ステージ済みの追加行のみを検査
    local diff_output
    diff_output=$(git diff --cached -U0 || true)

    if [[ -z "$diff_output" ]]; then
        print_pass "差分なし"
        return
    fi

    # 追加行（+で始まる行）のみ抽出。+++ ヘッダ行を明示的に除外
    local added_lines
    added_lines=$(printf '%s\n' "$diff_output" | grep '^+' | grep -v '^\+\+\+' || true)

    if [[ -z "$added_lines" ]]; then
        print_pass "追加行なし"
        return
    fi

    local found=0

    # パターン検査の共通関数
    # 外部変数: added_lines（入力）、found（マッチ時に 1 を設定）
    check_pattern() {
        local label="$1" pattern="$2" case_insensitive="${3:-false}"
        local -a grep_opts=(-qE)
        [[ "$case_insensitive" == "true" ]] && grep_opts+=(-i)
        if printf '%s\n' "$added_lines" | grep "${grep_opts[@]}" -- "$pattern"; then
            print_fail "$label"
            found=1
        fi
    }

    # 秘密鍵ヘッダ（RSA, EC, DSA, OPENSSH, ENCRYPTED 等に対応）
    check_pattern "秘密鍵が検出されました（PRIVATE KEY）" '-----BEGIN [A-Z ]+PRIVATE KEY-----'
    # AWS アクセスキー
    check_pattern "AWS アクセスキーが検出されました" 'AKIA[0-9A-Z]{16}'
    # GitHub トークン（classic PAT）
    check_pattern "GitHub トークンが検出されました" 'gh[po]_[A-Za-z0-9_]{36,}'
    # GitHub fine-grained PAT
    check_pattern "GitHub fine-grained PAT が検出されました" 'github_pat_[A-Za-z0-9_]{82,}'
    # OpenAI / Anthropic / Stripe 等の API キー（sk- プレフィックス全般を広めにカバー）
    check_pattern "API キーが検出されました（sk-*）" 'sk-[A-Za-z0-9]{20,}'
    # Slack トークン
    check_pattern "Slack トークンが検出されました" 'xox[baprs]-[A-Za-z0-9\-]{10,}'
    # Google API キー
    check_pattern "Google API キーが検出されました" 'AIza[0-9A-Za-z\-_]{35}'
    # credential 代入の検出（8文字以上の値）
    check_pattern "パスワード/シークレットキーの代入が検出されました" \
        '(password|secret_key|api_key|access_token|auth_token|client_secret)\s*[=:]\s*.{8,}' "true"

    if [[ "$found" -eq 1 ]]; then
        echo ""
        print_fail "シークレットが検出されました。コミットをブロックします"
        echo -e "  バイパス: ${YELLOW}git commit --no-verify${NC}"
        exit_code=1
    else
        print_pass "secrets"
    fi
}

# --------------------------------------------------------------------------
# メイン
# --------------------------------------------------------------------------
echo ""
run_shellcheck
echo ""
run_secrets_check
echo ""

exit $exit_code
