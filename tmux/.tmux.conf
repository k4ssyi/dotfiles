# ---------------------------------------------------------
# plugin
# ---------------------------------------------------------
# NOTE: catppuccin は resurrect/continuum より前に宣言すること
#       （ステータスバー編集の競合を防止）

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-open'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# ---------------------------------------------------------
# basic
# ---------------------------------------------------------

# tmux起動時のシェルをユーザーのデフォルトシェルに
# NOTE: $SHELL はtmuxサーバー起動時の環境変数を参照する
set -g default-shell "$SHELL"
set -g default-command "$SHELL"

# 256色表示可能に変更
set -g default-terminal "tmux-256color"
set -g terminal-overrides 'xterm:colors=256'

# True colorサポートを追加
set -sa terminal-features 'xterm-256color:RGB'
set -sa terminal-overrides 'xterm-256color:Tc'

# Neovim/Vimのモード切替遅延を防止（sensibleでも設定されるが明示）
set -sg escape-time 0

# Neovimのautoread等に必要（ペイン切替時のファイル変更検出）
set -g focus-events on

# マウス操作を有効にする
set -g mouse on

# 非アクティブペインの背景を暗くしてフォーカスを明示する
# Mantle(#181825) = Base(#1e1e2e) より一段暗い Catppuccin Mocha カラー
set -g window-style 'bg=#181825'
set -g window-active-style 'bg=#1e1e2e'

# prefix + q のペイン番号表示を2秒間維持（デフォルト500ms）
set -g display-panes-time 2000

# ウィンドウ・ペインのインデックスを1から始める
set -g base-index 1
set -g pane-base-index 1

# ウィンドウ削除時に番号を自動で詰める
set -g renumber-windows on

# スクロールバックバッファ
set -g history-limit 50000

# コマンド名→Nerd Fontアイコン変換
# 対応: nvim→, zsh/bash→, node→, python→, ssh→, docker→, その他→
set -g @cmd-icon '#{?#{==:#{pane_current_command},nvim}, ,#{?#{m:*sh,#{pane_current_command}}, ,#{?#{==:#{pane_current_command},node}, ,#{?#{m:python*,#{pane_current_command}}, ,#{?#{==:#{pane_current_command},ssh}, ,#{?#{==:#{pane_current_command},docker}, , }}}}}}'

# ターミナルのタイトルバーにセッション情報を表示
set -g set-titles on
set -g set-titles-string '#{E:@cmd-icon} #{pane_current_command} - #{b:pane_current_path} (#S:#I)'

# ステータスバーを下部に表示する
set -g status-position bottom
# status line を更新する間隔を 5 秒にする
set -g status-interval 5
# window-status を左揃えで配置する
set -g status-justify left

# ---------------------------------------------------------
# mapping
# ---------------------------------------------------------

# copy-modeでURL上にカーソルを合わせて「o」を押すと、デフォルトブラウザでURLを開く（tmux-openプラグイン）
# 詳細: https://github.com/tmux-plugins/tmux-open

# .tmux.confの読み込み
bind r source-file ~/.tmux.conf\; display-message "$HOME/.tmux.conf reloaded!"

# choose-tree をカスタムフォーマットで表示
# NOTE: choose-tree -F はセッション行・ウィンドウ行の両方に適用される
#       #{window_id} の有無でセッション行かウィンドウ行かを判定
bind w choose-tree -Zw -F '#{?#{window_id},#{window_index}: #{pane_current_command} [#{b:pane_current_path}] (#{window_panes} panes),#{session_name} (#{session_windows} windows)}'
bind s choose-tree -Zs -F '#{?#{window_id},  #{window_index}: #{pane_current_command} [#{b:pane_current_path}],#{session_name}: #{session_windows} windows #{?session_attached,(attached),(detached)}}'

# ---------------------------------------------------------
# copy mode
# ---------------------------------------------------------

set -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# コピー後もコピーモードを維持する（スクロール位置を保持）
set -g @yank_action 'copy-pipe-no-clear'

# ---------------------------------------------------------
# tmux-thumbs（ヒントベースのテキストコピー）
# ---------------------------------------------------------
# prefix + Space でペイン内のURL・パス・ハッシュ等をハイライト
# ヒント文字を押すとクリップボードにコピー

# Catppuccin Mocha に合わせたヒント色
set -g @thumbs-hint-fg-color blue
set -g @thumbs-hint-bg-color default
set -g @thumbs-contrast 1

# ---------------------------------------------------------
# tmux-resurrect / tmux-continuum（セッション永続化）
# ---------------------------------------------------------
# prefix + Ctrl-s で保存、prefix + Ctrl-r で復元

# ペイン内容も保存・復元する
set -g @resurrect-capture-pane-contents 'on'

# 自動保存間隔（分）
set -g @continuum-save-interval '15'

# セッション復元は手動で行う（prefix + Ctrl-r）
# 自動復元はデタッチ後の再アタッチ時に意図しない復元を引き起こすため無効化
set -g @continuum-restore 'off'

# ---------------------------------------------------------
# status bar
# ---------------------------------------------------------

# catppuccin options
set -g @catppuccin_flavor 'mocha' # latte, frappe, macchiato or mocha
set -g @catppuccin_window_status_style "rounded"
set -g @catppuccin_date_time_text " %H:%M"

# ウィンドウフラグをアイコンで表示（現在/直前/ズーム/アクティビティ等）
set -g @catppuccin_window_flags "icon"

# ペインボーダーにカレントディレクトリを表示
set -g @catppuccin_pane_status_enabled "yes"
set -g @catppuccin_pane_border_status "top"

# Make the status line pretty and add some modules
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -agF status-right "#{E:@catppuccin_status_cpu}"
set -ag status-right "#{E:@catppuccin_status_session}"
set -ag status-right "#{E:@catppuccin_status_uptime}"
set -ag status-right "#{E:@catppuccin_status_date_time}"
set -agF status-right "#{E:@catppuccin_status_battery}"

# ---------------------------------------------------------
# initialize tmux plugin manager
# ---------------------------------------------------------

run '~/.tmux/plugins/tpm/tpm'
